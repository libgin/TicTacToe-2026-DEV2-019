name: UI Tests

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"

jobs:
  ui-tests:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Xcode version
        run: xcodebuild -version
      - name: Create simulator
        id: sim
        run: |
          RUNTIME=$(xcrun simctl list runtimes -j | python3 -c 'import json,sys; data=json.load(sys.stdin); runtimes=[r for r in data.get("runtimes",[]) if r.get("isAvailable") and r.get("identifier","").startswith("com.apple.CoreSimulator.SimRuntime.iOS")]; runtimes.sort(key=lambda r: r.get("version","")); print(runtimes[-1]["identifier"] if runtimes else "")')
          if [ -z "$RUNTIME" ]; then
            echo "No iOS runtime found" >&2
            exit 1
          fi
          DEVICE=$(xcrun simctl create "iPhone-15" "iPhone 15" "$RUNTIME")
          echo "device=$DEVICE" >> "$GITHUB_OUTPUT"
      - name: Run UI tests
        run: |
          xcodebuild \
            -project TicTacToe/TicTacToe.xcodeproj \
            -scheme TicTacToe \
            -destination "id=${{ steps.sim.outputs.device }}" \
            -parallel-testing-enabled NO \
            -maximum-concurrent-test-simulator-destinations 1 \
            -only-testing:TicTacToeUITests \
            test
